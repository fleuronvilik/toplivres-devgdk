<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}{% endblock %}</title>
    <script type="module" src="{{ url_for('static', filename='js/app.js') }}" defer></script>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

  <body>
    <a class="skip-link" href="#main">Skip to main content</a>
    {% if role == 'admin' %}
    <nav id="admin-nav" class="nav">
      <div class="container">
        <a href="/admin" class="nav-link">Operations</a>
        <a href="/" class="nav-link">Books</a>
        <a href="#" id="logoutLink" class="nav-link">Logout</a>
      </div>
    </nav>
    {% endif %}
    <main id="main" class="container" tabindex="-1" data-role="{{ role }}">
        {% if not role %}
        <div id="login-section" class="hidden">
            <form id="loginForm" class="card">
                <label>Email: <input type="email" name="email" required></label>
                <label>Password: <input type="password" name="password" required></label>
                <button type="submit" class="btn btn-submit">Login</button>
            </form>
        </div>
        {% else %}
        {% block content %}{% endblock %}
        {% endif %}
    </main>
    <script type="module">
      // Global logout: call API to unset cookies, then clear local state
      import { apiFetch } from "{{ url_for('static', filename='js/utils/api.js') }}";
      (function(){
        const link = document.getElementById('logoutLink');
        if (!link) return;
        link.addEventListener('click', async function(e){
          e.preventDefault();
          try {
            await apiFetch('/api/auth/logout');
          } catch (err) {
            // Even if the request fails, proceed with client cleanup
          } finally {
            try {
              localStorage.removeItem('token');
              localStorage.removeItem('currentUser');
            } catch (e) {}
            // Redirect to home; router/login will take over
            location.assign('/');
          }
        });
      })();
    </script>
  </body>
</html>
